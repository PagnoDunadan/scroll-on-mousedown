<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
      integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
      crossorigin="anonymous"
    />
    <title>Scroll on mousedown</title>
    <!-- TODO: Remove unnecessary styling -->
    <style>
      body {
        width: 150%;
      }
      #scrollable {
        display: flex;
        background-color: red;
        width: 400px;
        overflow: hidden;
        padding: 10px;
        scroll-behavior: smooth;
      }
      #scrollable > button:not(:first-child) {
        margin-left: 10px;
      }
      .buttons {
        white-space: nowrap;
        min-width: auto;
      }
      .disable-text-select {
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }
      .header {
        display: flex;
        margin-left: 200px;
        margin-top: 100px;
      }
    </style>
  </head>

  <body>
    <div class="header">
      <button class="btn btn-light">X</button>
      <div id="scrollable" class="disable-text-select">
        <button class="btn btn-light buttons">English 1</button>
        <button class="btn btn-light buttons">English 2</button>
        <button class="btn btn-light buttons">English 3</button>
        <button class="btn btn-light buttons">English 4</button>
        <button class="btn btn-light buttons">English 5</button>
        <button class="btn btn-light buttons">English 6</button>
        <button class="btn btn-light buttons">English 7</button>
        <button class="btn btn-light buttons">English 8</button>
        <button class="btn btn-light buttons">English 9</button>
        <button class="btn btn-light buttons">English 10</button>
      </div>
      <button class="btn btn-light">Status: SHOW</button>
    </div>

    <script>
      // TODO: Make code work in IE 11
      (function() {
        const html = document.querySelector("html");
        const header = document.querySelector("#scrollable");
        let oldScrollBehavior;
        let positionX;

        header.addEventListener("mousedown", registerScroll);

        function registerScroll(event) {
          console.log("registerScroll");
          oldScrollBehavior = header.style.scrollBehavior;
          header.style.scrollBehavior = "auto";
          positionX = event.pageX;
          html.addEventListener("mousemove", doScroll);
          html.addEventListener("mouseup", removeScroll);
          html.addEventListener("mouseleave", removeScroll);
        }

        function removeScroll(event) {
          console.log("removeScroll");
          header.style.scrollBehavior = oldScrollBehavior;
          html.removeEventListener("mousemove", doScroll);
          html.removeEventListener("mouseup", removeScroll);
          html.removeEventListener("mouseleave", removeScroll);
        }

        function doScroll(event) {
          console.log("doScroll");
          const newPositionX = event.pageX;
          if (newPositionX < positionX) {
            header.scrollLeft += positionX - newPositionX;
          } else if (newPositionX > positionX) {
            header.scrollLeft += -(newPositionX - positionX);
          }
          positionX = newPositionX;
        }
      })();

      (function() {
        const header = document.querySelector("#scrollable");
        let oldOverflowX;
        header.addEventListener("touchstart", registerMobileScroll);

        function registerMobileScroll(event) {
          console.log("registerMobileScroll");
          oldOverflowX = header.style.overflowX;
          header.style.overflowX = "scroll";
          header.addEventListener("touchend", removeMobileScroll);
          header.addEventListener("touchcancel", removeMobileScroll);
        }

        function removeMobileScroll(event) {
          console.log("removeMobileScroll");
          header.style.overflowX = oldOverflowX;
          header.removeEventListener("touchend", removeMobileScroll);
          header.removeEventListener("touchcancel", removeMobileScroll);
        }
      })();

      (function() {
        const header = document.querySelector("#scrollable");
        const buttons = document.querySelectorAll(".buttons");
        const moveThreshold = 2;
        let positionX;
        let positionY;

        for (let i = 0; i < buttons.length; i++) {
          const button = buttons[i];
          button.addEventListener("click", doMove);
          button.addEventListener("mousedown", saveInitialPosition);
        }

        function saveInitialPosition(event) {
          positionX = event.pageX;
          positionY = event.pageY;
        }

        function stopIfMouseMoved(event) {
          const newPositionX = event.pageX;
          const newPositionY = event.pageY;

          const newTotal = newPositionX + newPositionY;
          const oldTotal = positionX + positionY;

          if (Math.abs(oldTotal - newTotal) > moveThreshold) return true;
          return false;
        }

        function doMove(event) {
          const stop = stopIfMouseMoved(event);
          if (stop) return;
          console.log("doMove");

          const button = event.target;
          const buttonOffset = button.getBoundingClientRect().left;
          const buttonWidth = button.getBoundingClientRect().width;
          const headerOffset = header.getBoundingClientRect().left;
          const headerWidth = header.getBoundingClientRect().width;

          const currentPosition = buttonOffset + buttonWidth / 2;
          const moveTo = headerOffset + headerWidth / 2;

          header.scrollLeft += currentPosition - moveTo;
        }
      })();
    </script>
  </body>
</html>
